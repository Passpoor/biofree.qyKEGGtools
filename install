# ============================================================
# ğŸ“¦ æ„å»ºå¯åˆ†äº«ç‰ˆæœ¬ biofree.qyKEGGtools v2.0.0
# ============================================================

# å…ˆæ¸…é™¤æ—§åŒ…
if ("biofree.qyKEGGtools" %in% installed.packages()[,1]) {
  detach("package:biofree.qyKEGGtools", unload = TRUE, character.only = TRUE)
  remove.packages("biofree.qyKEGGtools")
  cat("ğŸ§¹ å·²å¸è½½æ—§ç‰ˆ biofree.qyKEGGtoolsã€‚\n")
}

if (!requireNamespace("devtools", quietly = TRUE)) install.packages("devtools")
if (!requireNamespace("usethis", quietly = TRUE)) install.packages("usethis")

library(devtools)
library(usethis)

# ============================================================
# Step 1. åˆ›å»ºåŒ…éª¨æ¶
# ============================================================
pkg_dir <- file.path(tempdir(), "biofree.qyKEGGtools")
if (dir.exists(pkg_dir)) unlink(pkg_dir, recursive = TRUE)
usethis::create_package(pkg_dir, open = FALSE)
setwd(pkg_dir)

# ============================================================
# Step 2. å†™å…¥ DESCRIPTION
# ============================================================
writeLines('
Package: biofree.qyKEGGtools
Type: Package
Title: Smart Offline KEGG Enrichment Tool with Auto Update
Version: 2.0.0
Authors@R: 
    person("Qiaoyu", "Chen", email = "persist2021@163.com", role = c("aut", "cre"))
Description: Provides offline KEGG enrichment analysis with automatic local database update (via createKEGGdb) and optional GitHub self-update. 
    Compatible with clusterProfiler, supports human (hsa) and mouse (mmu).
License: MIT + file LICENSE
Encoding: UTF-8
LazyData: true
Depends: R (>= 4.0.0)
Imports:
    DBI,
    RSQLite,
    clusterProfiler,
    createKEGGdb,
    httr,
    jsonlite,
    remotes
RoxygenNote: 7.3.1
', "DESCRIPTION")

# ============================================================
# Step 3. å†™å…¥ NAMESPACE
# ============================================================
writeLines('
export(load_local_kegg)
export(enrich_local_KEGG)
export(update_local_kegg)
export(check_biofree_update)
', "NAMESPACE")

dir.create("R", showWarnings = FALSE)

# ============================================================
# Step 4. å†™å…¥å‡½æ•°æ–‡ä»¶
# ============================================================

# ---- load_local_kegg.R ----
writeLines('
# ============================================================
# ğŸ§© KEGG æ•°æ®åŠ è½½æ¨¡å—
# ============================================================

#\' @export
load_local_kegg <- function(species = "hsa", db_dir = "~/biofree_KEGG_mirror", rebuild = FALSE) {
  if (!dir.exists(db_dir)) dir.create(db_dir, recursive = TRUE)
  db_path <- file.path(db_dir, paste0("KEGG_", species, ".sqlite"))
  
  if (!file.exists(db_path) || rebuild) {
    message("[INFO] æœªæ£€æµ‹åˆ°æœ¬åœ° KEGG æ•°æ®åº“ï¼Œæ­£åœ¨æ„å»ºç‰©ç§: ", species)
    if (!requireNamespace("createKEGGdb", quietly = TRUE)) {
      stop(\'âŒ éœ€è¦å®‰è£… createKEGGdb åŒ…: install.packages("createKEGGdb")\')
    }
    tmp_tar <- createKEGGdb::create_kegg_db(species)
    untar_dir <- tempfile()
    untar(tmp_tar, exdir = untar_dir)
    sqlite_file <- list.files(untar_dir, pattern = "[.]sqlite$", recursive = TRUE, full.names = TRUE)[1]
    if (is.na(sqlite_file) || !file.exists(sqlite_file)) {
      stop("âŒ æ„å»º KEGG æ•°æ®åº“å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç‰©ç§ä»£å·ã€‚")
    }
    file.copy(sqlite_file, db_path, overwrite = TRUE)
    message("âœ… å·²æ„å»ºå¹¶ä¿å­˜è‡³: ", db_path)
  } else {
    message("âœ… æ£€æµ‹åˆ°æœ¬åœ°æ•°æ®åº“: ", db_path)
  }
  
  db <- RSQLite::dbConnect(RSQLite::SQLite(), db_path)
  tables <- DBI::dbListTables(db)
  message("[INFO] å·²è¿æ¥æ•°æ®åº“ (", species, ")ã€‚åŒ…å«è¡¨: ", paste(tables, collapse = ", "))
  return(db)
}
', "R/load_local_kegg.R")

# ---- enrich_local_KEGG.R ----
writeLines('
# ============================================================
# ğŸš€ KEGG å¯Œé›†åˆ†ææ¨¡å—
# ============================================================
#\' @export
enrich_local_KEGG <- function(gene, species = "hsa", db_dir = "~/biofree_KEGG_mirror",
                              pCutoff = 0.05, qCutoff = 0.2) {
  if (missing(gene) || length(gene) == 0) stop("âŒ gene åˆ—è¡¨ä¸èƒ½ä¸ºç©ºã€‚")
  db <- load_local_kegg(species = species, db_dir = db_dir)
  path2gene <- DBI::dbGetQuery(db, "SELECT * FROM pathway2gene")
  path2name <- DBI::dbGetQuery(db, "SELECT * FROM pathway2name")

  res <- clusterProfiler::enricher(
    gene = gene,
    TERM2GENE = path2gene,
    TERM2NAME = path2name,
    pvalueCutoff = pCutoff,
    qvalueCutoff = qCutoff
  )
  RSQLite::dbDisconnect(db)
  message("ğŸ¯ ", species, " çš„ KEGG å¯Œé›†åˆ†æå®Œæˆï¼Œå…±æ£€æµ‹åˆ° ", nrow(res@result), " ä¸ªé€šè·¯ã€‚")
  return(res)
}
', "R/enrich_local_KEGG.R")

# ---- update_local_kegg.R ----
writeLines('
# ============================================================
# ğŸ”„ è‡ªåŠ¨æ›´æ–° KEGG æ•°æ®åº“
# ============================================================
#\' @export
update_local_kegg <- function(species = "hsa", db_dir = "~/biofree_KEGG_mirror", max_age_days = 30, force = FALSE) {
  if (!requireNamespace("createKEGGdb", quietly = TRUE)) stop("âŒ è¯·å…ˆå®‰è£… createKEGGdbã€‚")
  if (!dir.exists(db_dir)) dir.create(db_dir, recursive = TRUE)
  db_path <- file.path(db_dir, paste0("KEGG_", species, ".sqlite"))
  need_update <- force
  if (file.exists(db_path)) {
    mod_time <- file.info(db_path)$mtime
    age_days <- as.numeric(difftime(Sys.time(), mod_time, units = "days"))
    message("ğŸ“… ", species, " æ•°æ®åº“æ›´æ–°æ—¶é—´: ", format(mod_time, "%Y-%m-%d"), "ï¼ˆ", round(age_days, 1), " å¤©å‰ï¼‰")
    if (age_days > max_age_days) {
      message("ğŸ”„ è¶…è¿‡ ", max_age_days, " å¤©ï¼Œå‡†å¤‡æ›´æ–°ã€‚")
      need_update <- TRUE
    }
  } else {
    message("âš ï¸ æœªå‘ç°æ•°æ®åº“ï¼Œå°†æ–°å»ºã€‚")
    need_update <- TRUE
  }

  if (need_update) {
    tmp_tar <- createKEGGdb::create_kegg_db(species)
    untar_dir <- tempfile()
    untar(tmp_tar, exdir = untar_dir)
    sqlite_file <- list.files(untar_dir, pattern = "[.]sqlite$", recursive = TRUE, full.names = TRUE)[1]
    if (is.na(sqlite_file)) stop("âŒ æ•°æ®åº“æ›´æ–°å¤±è´¥ã€‚")
    file.copy(sqlite_file, db_path, overwrite = TRUE)
    message("âœ… å·²æ›´æ–°è‡³æœ€æ–° KEGG æ•°æ®åº“ï¼š", db_path)
  } else {
    message("âœ… æ•°æ®åº“ä»ä¸ºæœ€æ–°ï¼Œæ— éœ€æ›´æ–°ã€‚")
  }
}
', "R/update_local_kegg.R")

# ---- check_biofree_update.R ----
writeLines('
# ============================================================
# ğŸŒ è‡ªåŠ¨æ£€æµ‹åŒ…æ›´æ–°
# ============================================================
#\' @export
check_biofree_update <- function(repo = "biofree-lab/biofree.qyKEGGtools", auto_install = TRUE) {
  if (!requireNamespace("httr", quietly = TRUE)) install.packages("httr")
  if (!requireNamespace("jsonlite", quietly = TRUE)) install.packages("jsonlite")
  current_ver <- as.character(utils::packageVersion("biofree.qyKEGGtools"))
  message("ğŸ“¦ å½“å‰ç‰ˆæœ¬: ", current_ver)
  url <- paste0("https://api.github.com/repos/", repo, "/releases/latest")
  res <- httr::GET(url)
  if (httr::status_code(res) != 200) {
    warning("âš ï¸ æ— æ³•è®¿é—® GitHub release ä¿¡æ¯ã€‚")
    return(invisible(NULL))
  }
  latest <- jsonlite::fromJSON(httr::content(res, as = "text", encoding = "UTF-8"))
  latest_ver <- gsub("^v", "", latest$tag_name)
  message("ğŸŒ æœ€æ–°ç‰ˆæœ¬: ", latest_ver)
  if (utils::compareVersion(latest_ver, current_ver) > 0) {
    message("ğŸš€ å‘ç°æ–°ç‰ˆæœ¬ï¼Œå¯æ›´æ–°è‡³ ", latest_ver)
    if (auto_install) {
      if (!requireNamespace("remotes", quietly = TRUE)) install.packages("remotes")
      remotes::install_github(repo, upgrade = "never")
      message("âœ… å·²æ›´æ–°è‡³æœ€æ–°ç‰ˆæœ¬ ", latest_ver)
    }
  } else {
    message("âœ… å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ã€‚")
  }
}
', "R/check_biofree_update.R")

# ---- zzz.R ----
writeLines('
.onAttach <- function(libname, pkgname) {
  packageStartupMessage("ğŸ’¡ biofree.qyKEGGtools v2.0.0 å·²åŠ è½½ã€‚")
  packageStartupMessage("ğŸ“… å¯ä½¿ç”¨ update_local_kegg() æ£€æŸ¥ KEGG æ•°æ®åº“æ›´æ–°ã€‚")
}
', "R/zzz.R")

# ============================================================
# Step 5. æ„å»ºå¹¶å®‰è£…
# ============================================================
tar_path <- devtools::build(pkg_dir)
cat("âœ… æ–°ç‰ˆæ„å»ºå®Œæˆï¼š", tar_path, "\n")

# å®‰è£…åˆ°æœ¬åœ°
install.packages(tar_path, repos = NULL, type = "source")

# æµ‹è¯•åŠ è½½
library(biofree.qyKEGGtools)
